<!DOCTYPE html>
<html>
<head>
    <title>WebAuthn Demo</title>
</head>
<body>
<button onclick="register()">Register</button>
<button onclick="authenticate()">Authenticate</button>

<script>
    // Convert base64url to ArrayBuffer
    function base64urlToBuffer(base64url) {
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Convert ArrayBuffer to base64url
    function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary)
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=/g, '');
    }

    async function register() {
        try {
            // Get registration options from server
            const response = await fetch('/register');
            const options = await response.json();

            // Convert challenge from base64 to ArrayBuffer
            options.publicKey.challenge = base64urlToBuffer(
                options.publicKey.challenge
            );

            // Convert user.id from base64 to ArrayBuffer
            options.publicKey.user.id = base64urlToBuffer(
                options.publicKey.user.id
            );

            // Create credential
            const credential = await navigator.credentials.create(options);

            // Prepare response for server
            const attestationResponse = {
                id: credential.id,
                rawId: bufferToBase64url(credential.rawId),
                type: credential.type,
                response: {
                    attestationObject: bufferToBase64url(
                        credential.response.attestationObject
                    ),
                    clientDataJSON: bufferToBase64url(
                        credential.response.clientDataJSON
                    )
                }
            };

            // Send to server
            await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(attestationResponse)
            });

            alert('Registration successful!');
        } catch (error) {
            console.error('Registration failed:', error);
            alert('Registration failed');
        }
    }

    async function authenticate() {
        try {
            // Get authentication options from server
            const response = await fetch('/authenticate');
            const options = await response.json();

            // Convert challenge and credential id
            options.publicKey.challenge = base64urlToBuffer(
                options.publicKey.challenge
            );

            /*
            options.publicKey.allowCredentials.forEach(cred => {
                cred.id = base64urlToBuffer(cred.id);
            });
            */
            // Get assertion
            const credential = await navigator.credentials.get(options);

            // Prepare response for server
            const assertionResponse = {
                id: credential.id,
                rawId: bufferToBase64url(credential.rawId),
                type: credential.type,
                response: {
                    authenticatorData: bufferToBase64url(
                        credential.response.authenticatorData
                    ),
                    clientDataJSON: bufferToBase64url(
                        credential.response.clientDataJSON
                    ),
                    signature: bufferToBase64url(
                        credential.response.signature
                    ),
                    userHandle: credential.response.userHandle ?
                        bufferToBase64url(credential.response.userHandle) : null
                }
            };

            // Send to server
            await fetch('/authenticate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(assertionResponse)
            });

            alert('Authentication successful!');
        } catch (error) {
            console.error('Authentication failed:', error);
            alert('Authentication failed');
        }
    }
</script>
</body>
</html>