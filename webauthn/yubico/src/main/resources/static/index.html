<!DOCTYPE html>
<html>
<head>
    <title>WebAuthn Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/@simplewebauthn/browser@7.2.0/dist/bundle/index.umd.min.js"></script>
</head>
<body>
<h1>WebAuthn Demo</h1>

<div id="registration">
    <h2>Register</h2>
    <input type="text" id="regUsername" placeholder="Username">
    <input type="text" id="regDisplayName" placeholder="Display Name">
    <button onclick="register()">Register with WebAuthn</button>
</div>

<hr>

<div id="authentication">
    <h2>Login</h2>
    <input type="text" id="authUsername" placeholder="Username">
    <button onclick="login()">Login with WebAuthn</button>
</div>

<div id="result"></div>

<script>
    const API_BASE = '/api/webauthn';

    async function register() {
        const username = document.getElementById('regUsername').value;
        const displayName = document.getElementById('regDisplayName').value;

        // Step 1: Get registration options
        const startResp = await fetch(`${API_BASE}/register/start`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, displayName})
        });

        const options = await startResp.json();

        // Step 2: Create credential in browser
        const credential = await SimpleWebAuthnBrowser.startRegistration(options);

        // Step 3: Send credential to server
        const finishResp = await fetch(`${API_BASE}/register/finish`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: username,
                credential: JSON.stringify(credential)
            })
        });

        const result = await finishResp.json();
        showResult(result.message);
    }

    async function login() {
        const username = document.getElementById('authUsername').value;

        // Step 1: Get authentication options
        const startResp = await fetch(`${API_BASE}/login/start`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username})
        });

        const options = await startResp.json();

        // Step 2: Get assertion from browser
        const assertion = await SimpleWebAuthnBrowser.startAuthentication(options);

        // Step 3: Verify assertion on server
        const finishResp = await fetch(`${API_BASE}/login/finish`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: username,
                assertion: JSON.stringify(assertion)
            })
        });

        const result = await finishResp.json();
        showResult(result.message);

        if (result.success) {
            // Store session
            localStorage.setItem('sessionId', result.sessionId);
        }
    }

    function showResult(message) {
        document.getElementById('result').innerHTML =
            `<p><strong>Result:</strong> ${message}</p>`;
    }
</script>
</body>
</html>